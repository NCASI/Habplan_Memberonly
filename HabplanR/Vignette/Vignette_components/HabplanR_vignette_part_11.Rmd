---
output: word_document
vignette: >
  %\VignetteIndexEntry{HabplanR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  root.dir = 'C:/Users/maxdoltonjones/Documents/Habplan/HabplanR/HabplanR'
)
```

```{r, wd.1, include = FALSE, echo = F}

setwd("C:/Users/maxdoltonjones/Documents/Habplan/HabplanR/HabplanR")

```


```{r, include = FALSE, echo = F}

library(readr)
library(dplyr)
library(ggplot2)
library(broom)
library(spdep)
library(terra)
library(tidyterra)
library(HabplanR)

std.data <- read_csv("fvs_results.csv")

```

Similar to our other outputs from Habplan, we can read in the output flow files and plot them. We are going to compare the results to those of the Metropolis Hastings algorithm from the third run above. 

```{r flow.read.lp.1, warning = FALSE, echo = T, eval = F}

#Read in the flow files
flow1 <- read.csv("./saveFlow1", sep="", header = F)
flow2 <- read.csv("./saveFlow2", sep="", header = F)

```

```{r flow.read.lp.1.1, warning = FALSE, echo = F, eval = T}

#Read in the flow files
flow1 <- read.csv("./Run_LP/saveFlow1", sep="", header = F)
flow2 <- read.csv("./Run_LP/saveFlow2", sep="", header = F)

```

```{r flow.func, warning = FALSE, echo = F, eval = F}

flowPlot <- function (flow.data, nyear) 
{
  flow.list <- vector(mode = "list", length = nyear)
  flow1 <- flow.data
  for (i in 1:length(flow.list)) {
    std <- cbind(flow1[2], flow1[i + 3], flow1[i + (nyear + 
      3)])
    colnames(std) <- c("id", "year", "flow")
    std$flow <- gsub("[,]", "", std$flow)
    std$year <- gsub("[,]", "", std$year)
    std$id <- gsub("[,]", "", std$id)
    std$flow <- as.numeric(std$flow)
    tot.flow <- sum(std$flow)
    flow.list[i] <- tot.flow
  }
  year <- c(1:nyear)
  flow <- t(flow.list)
  flow <- t(flow)
  f1.output <- cbind(year, flow)
  f1.output <- as.data.frame(f1.output)
  colnames(f1.output) <- c("year", "flow")
  f1.output$flow <- as.numeric(f1.output$flow)
  f1.output$year <- as.numeric(f1.output$year)
  f1.plot <- ggplot(data = f1.output) + geom_line(aes(x = year, 
    y = flow)) + geom_area(aes(x = year, y = flow), fill = "grey", 
    alpha = 0.7) + ggtitle("Flow output over time") + xlab("Year") + 
    ylab("Flow") + theme_classic() + theme(legend.position = "none")
  
  ggsave(file = paste0("./Single_flow.png"), 
    width = 200, height = 120, dpi = 600, units = "mm")
  return(f1.plot)
}


```

```{r lp.filt, warning = FALSE, echo = F, eval = T}

#The LP Solver produces a flow files that has multiple possible regimes.
#We will filter the flow file to provide one example, but view the file
#to look at the corresponding id numbers under the V1 column.
#flow1 <- flow1 %>%
#  filter(V1 == "1,")

#flow2 <- flow2 %>%
#  filter(V1 == "1,")

```

```{r flow.plot.x, warning = FALSE, echo = T, eval = T}

#Input the flow file into the function, and number of years
flowPlot(flow.data = flow1, nyear = 35)

```

Figure 30. The amount of flow (habitat area) attained over time as a result of the suggested Habplan management schedule, based on Habplan linear programming.

```{r flow.plot.y, warning = FALSE, echo = T, eval = T}

#Input the flow file into the function, and number of years
flowPlot(flow.data = flow2, nyear = 35)

```

Figure 31. The amount of flow (harvested pine pulpwood) attained over time as a result of the suggested Habplan management schedule, based on Habplan linear programming.

```{r com.plot.func, warning = FALSE, echo = F, eval = F}

comPlot <- function (flow.data.1, flow.data.2, flow.data.3, nyear) 
{
  flow.list.1 <- vector(mode = "list", length = nyear)
  flow1 <- flow.data.1
  for (i in 1:length(flow.list.1)) {
    std <- cbind(flow1[2], flow1[i + 3], flow1[i + (nyear + 
      3)])
    colnames(std) <- c("id", "year", "flow")
    std$flow <- gsub("[,]", "", std$flow)
    std$year <- gsub("[,]", "", std$year)
    std$id <- gsub("[,]", "", std$id)
    std$flow <- as.numeric(std$flow)
    tot.flow <- sum(std$flow)
    flow.list.1[i] <- tot.flow
  }
  year <- c(1:nyear)
  flow <- t(flow.list.1)
  flow <- t(flow)
  f1.output <- cbind(year, flow)
  f1.output <- as.data.frame(f1.output)
  colnames(f1.output) <- c("year", "flow")
  f1.output$flow <- as.numeric(f1.output$flow)
  f1.output$year <- as.numeric(f1.output$year)
  f1.output$num <- "flow 1"
  flow.list.2 <- vector(mode = "list", length = nyear)
  flow1 <- flow.data.2
  for (i in 1:length(flow.list.2)) {
    std <- cbind(flow1[2], flow1[i + 3], flow1[i + (nyear + 
      3)])
    colnames(std) <- c("id", "year", "flow")
    std$flow <- gsub("[,]", "", std$flow)
    std$year <- gsub("[,]", "", std$year)
    std$id <- gsub("[,]", "", std$id)
    std$flow <- as.numeric(std$flow)
    tot.flow <- sum(std$flow)
    flow.list.2[i] <- tot.flow
  }
  year <- c(1:nyear)
  flow <- t(flow.list.2)
  flow <- t(flow)
  f2.output <- cbind(year, flow)
  f2.output <- as.data.frame(f2.output)
  colnames(f2.output) <- c("year", "flow")
  f2.output$flow <- as.numeric(f2.output$flow)
  f2.output$year <- as.numeric(f2.output$year)
  f2.output$num <- "flow 2"
  flow.list.3 <- vector(mode = "list", length = nyear)
  flow1 <- flow.data.3
  for (i in 1:length(flow.list.3)) {
    std <- cbind(flow1[2], flow1[i + 3], flow1[i + (nyear + 
      3)])
    colnames(std) <- c("id", "year", "flow")
    std$flow <- gsub("[,]", "", std$flow)
    std$year <- gsub("[,]", "", std$year)
    std$id <- gsub("[,]", "", std$id)
    std$flow <- as.numeric(std$flow)
    tot.flow <- sum(std$flow)
    flow.list.3[i] <- tot.flow
  }
  year <- c(1:nyear)
  flow <- t(flow.list.3)
  flow <- t(flow)
  f3.output <- cbind(year, flow)
  f3.output <- as.data.frame(f3.output)
  colnames(f3.output) <- c("year", "flow")
  f3.output$flow <- as.numeric(f3.output$flow)
  f3.output$year <- as.numeric(f3.output$year)
  f3.output$num <- "flow 3"
  all.output <- rbind(f1.output, f2.output, f3.output)
  f1.plot <- ggplot(data = all.output) + geom_line(data = all.output, 
    aes(x = year, y = flow, group = num, color = num), position = "identity") + 
    geom_area(data = all.output, aes(x = year, y = flow, 
      group = num, fill = num), alpha = 0.5, position = "identity") + 
    scale_color_viridis_d(option = "viridis", begin = 0.3, 
      end = 0.6) + scale_fill_viridis_d(option = "viridis", 
    begin = 0.3, end = 0.6) + scale_x_continuous(breaks = seq(0, 
    nyear, 5)) + ggtitle("Flow output over time") + xlab("Year") + 
    ylab("Flow") + theme_classic() + guides(color = guide_legend(title = "Flow #"), 
    fill = guide_legend(title = "Flow #"))
  ggsave(file = paste0("./Combined_flows.png"), width = 200, 
    height = 120, dpi = 600, units = "mm")
  return(f1.plot)
}


```

Now that we have looked at the flows individually, we will use the _comPlot_ function to compare the original Habplan runs with the LP Solver.


```{r com.plot.lp, warning = FALSE, echo = T, eval = T}

#Let's compare the flows across runs. 
#For this example, we have saved the flow files in different folders
flow1 <- read_csv("./Run_2/saveFlow1", col_names = F)
flow2 <- read_csv("./Run_3/saveFlow1", col_names = F)
flow3 <- read_csv("./Run_LP/saveFlow1", col_names = F)
#flow4 <- read.csv("./saveFlow4", sep="")

#Run function with new flows
comPlot(flow.data.1 = flow1, flow.data.2 = flow2, 
        flow.data.3 = flow3, nyear = 35)

```

Figure 32. The amount of flow (habitat area) attained over time as a result of the three separate Habplan management schedule (flow1, flow2, and flow3 [linear programming]). Each flow is represented by a different shade of blue.

As can be seen from the above example, the suggested management regimes from the original Habplan run and the LP Solver can be very different. That's why it is important to look at each forestry problem using multiple methods and parameters, and plot them across time to find the "best" schedule.

## Function: Carbon data conversion: _CarbConvert_

In the member-only HabplanR version, we have also incorporated a new function for converting Carbon data into Habplan flow files, similar to the _HabConvert_ function introduced earlier in the vignette.

We need to provide the custom function with one argument only:

1. std.data: the flow information in csv format

We will read in the stand data with the carbon information embedded within.

```{r carb.data, warning = FALSE, message = F, eval = T, echo = T}

#Load in stand and corresponding Carbon data
std.data <- read_csv("./HSM_OUT_FINAL_MerchStds_wCarbon.csv")

```

Now we can run the _CarbConvert_ function. We only need to include our new std.data file for the function to run:

```{r carb.func.3, warning = FALSE, message = F, eval = F, echo = T}

#Run function
carb.flow <- CarbonConvert(std.data = std.data)

```

The above function will save a flow file called "Carbon_data.dat" in our working directory

We will use a previously highlighted function of HabplanR, _WriteProj_ to create a project file which can be loaded into Habplan to set parameters and other configurations. The only arguments needed for the actual function to work, are the object names for each flow component which needs to be included.

Since Habplan inputs allow for customization, we provide script which will allow users the same level of input manipulation. For our carbon workflow, we will only be working with one flow component: carbon.

```{r config.1, warning = FALSE, eval = F}

#Overarching information for habplan run:
#Get the number of stands for later
npoly <- length(unique(std.data$StandKey))
#Configuration - see Habplan Manual
config <- "1,0,0,0,0,0"
#wd is the working directory where Habplan and data are stored
wd <- "FILEPATH HERE"
#iter is the number of iterations needed for the Habplan run
iter <- "10000"

```

```{r flow.comp.1, warning = FALSE, eval = F}

f1.file <- "Carbon_data.dat"
f1.bygone <- ""
f1.time0 <- "100"
f1.goal0 <- "0.1"
f1.thlo <- "100"
f1.thhi <- "500"
f1.goalplus <- ".05"
f1.goalf <- "0.5"
f1.slope <- "0.0"
f1.weightf <- "1.0"
f1.weight0 <- "1.0"
f1.model <- "1,100;10,100;20,100;30,100"
f1.title <- "Carbon.dat"
#Combine f1 components for writing
f1.comp <- c('<flow title="F1 Component">',
             paste0('<file value="', f1.file, '" />'),
             paste0('<bygone value="', f1.bygone, '" />'),
             paste0('<time0 value="', f1.time0, '" />'),
             paste0('<goal0 value="', f1.goal0, '" />'),
             paste0('<threshLo value="', f1.thlo, '" />'),
             paste0('<threshHi value="', f1.thhi, '" />'),
             paste0('<goalPlus value="', f1.goalplus, '" />'),
             paste0('<goalF value="', f1.goalf, '" />'),
             paste0('<slope value="', f1.slope, '" />'),
             paste0('<weightF value="', f1.weightf, '" />'),
             paste0('<weight0 value="', f1.weight0, '" />'),
             paste0('<model value="', f1.model, '" />'),
             paste0('<title value="', f1.title, '" />'),
             '<bounds height="330" width="366" x="553" y="443" />',
             "</flow>")

```

```{r write.proj.3, warning = FALSE, echo = T, eval = F}

#Provide each of these flow component objects to the function and run
writeProj(f1.comp = f1.comp)


```

Now we have a project file saved to our working directory. Let's open Habplan and see if this has worked. The Habplan program needs to be stored in the working directory that was assigned earlier, so that it can be run from RStudio below.

_IMPORTANT - MUST RENAME OR MOVE SAVEFLOW1 AND SAVESCHED FROM WORKING DIRECTORY IF YOU DO NOT WANT THE FILES TO BE DELETED_

```{r run.habplan.1, warning = FALSE, echo = T, eval = F}

#Open Habplan (if run from here, R functionality will cease until Habplan is closed)
shell("h", wait=TRUE) 


```

After running Habplan, we will have a carbon flow saved to our working directory. The option still exists to interactively watch the charts in a Habplan window. However, we provide a function to visualize each flow individually.

```{r flow.read.1, warning = FALSE, echo = T, eval = F}

#Read in the Carbon flow file
flow1 <- read.csv("./saveFlow1", sep="", header = F)

```

```{r flow.read.1.1, warning = FALSE, echo = F, eval = T}

#Read in the Carbon flow file
flow1 <- read.csv("./Carb_1/saveFlow1", sep="", header = F)

```

_IMPORTANT - if the flow1 object has more rows than number of stands something went wrong. Most likely, the saveFlow1 file was not removed from the working directory before Habplan was run._

```{r flow.plot.1, warning = FALSE, echo = T, eval = T}

#Input the flow file into the function, and number of years
flowPlot(flow.data = flow1, nyear = 36) #Carbon dataset has 36 years, not 35.

```

Figure 33. The amount of flow (sequestered carbon) attained over time as a result of the suggested Habplan management schedule.

_Run 2_

For this second run, we will maintain the overarching Habplan paramaters, but will now change the upper threshold (thhi), lower threshold (thlo), and model values.

```{r flow.comp.2, warning = FALSE, eval = F}

f1.file <- "Carbon_data.dat"
f1.bygone <- ""
f1.time0 <- "5000"
f1.goal0 <- "0.1"
f1.thlo <- "5000"
f1.thhi <- "10000"
f1.goalplus <- ".05"
f1.goalf <- "0.5"
f1.slope <- "0.0"
f1.weightf <- "1.0"
f1.weight0 <- "1.0"
f1.model <- "1,10000;10,12000;20,12000;30,12000"
f1.title <- "Carbon.dat"
#Combine f1 components for writing
f1.comp <- c('<flow title="F1 Component">',
             paste0('<file value="', f1.file, '" />'),
             paste0('<bygone value="', f1.bygone, '" />'),
             paste0('<time0 value="', f1.time0, '" />'),
             paste0('<goal0 value="', f1.goal0, '" />'),
             paste0('<threshLo value="', f1.thlo, '" />'),
             paste0('<threshHi value="', f1.thhi, '" />'),
             paste0('<goalPlus value="', f1.goalplus, '" />'),
             paste0('<goalF value="', f1.goalf, '" />'),
             paste0('<slope value="', f1.slope, '" />'),
             paste0('<weightF value="', f1.weightf, '" />'),
             paste0('<weight0 value="', f1.weight0, '" />'),
             paste0('<model value="', f1.model, '" />'),
             paste0('<title value="', f1.title, '" />'),
             '<bounds height="330" width="366" x="553" y="443" />',
             "</flow>")

```

```{r write.proj.4, warning = FALSE, echo = T, eval = F}

#Provide each of these flow component objects to the function and run
writeProj(f1.comp = f1.comp)


```

Now we have a project file saved to our working directory. Let's open Habplan and see if this has worked. The Habplan program needs to be stored in the working directory that was assigned earlier, so that it can be run from RStudio below.

_IMPORTANT - MUST RENAME SAVEFLOW1 AND SAVESCHED FROM WORKING DIRECTORY IF YOU DO NOT WANT THE FILES TO BE DELETED_

```{r run.habplan.2, warning = FALSE, echo = T, eval = F}

#Open Habplan (if run from here, R functionality will cease until Habplan is closed)
shell("h", wait=TRUE) 


```

After running Habplan, we will have a carbon flow saved to our working directory. The option still exists to interactively watch the charts in a Habplan window. However, we will visualize this flow using the flowPlot function.

```{r flow.read.2, warning = FALSE, echo = T, eval = F}

#Read in the Carbon flow file
flow1 <- read.csv("./saveFlow1", sep="", header = F)

```

```{r flow.read.2.1, warning = FALSE, echo = F, eval = T}

#Read in the Carbon flow file
flow1 <- read.csv("./Carb_2/saveFlow1", sep="", header = F)

```

_IMPORTANT - if the flow1 object has more rows than number of stands something went wrong. Most likely, the saveFlow1 file was not removed from the working directory before Habplan was run._

```{r flow.plot.2, warning = FALSE, echo = T, eval = T}

#Input the flow file into the function, and number of years
flowPlot(flow.data = flow1, nyear = 36)

```

Figure 34. The amount of flow (sequestered carbon) attained over time as a result of the suggested Habplan management schedule.

_Run 3_

For this third run, we will maintain the overarching Habplan paramaters, but will now change the upper threshold (thhi), lower threshold (thlo), and model values.

```{r flow.comp.3, warning = FALSE, eval = F}

f1.file <- "Carbon_data.dat"
f1.bygone <- ""
f1.time0 <- "10000"
f1.goal0 <- "0.1"
f1.thlo <- "3000"
f1.thhi <- "15000"
f1.goalplus <- ".05"
f1.goalf <- "0.5"
f1.slope <- "0.0"
f1.weightf <- "1.0"
f1.weight0 <- "1.0"
f1.model <- "1,15000;10,15000;20,15000;30,15000"
f1.title <- "Carbon.dat"
#Combine f1 components for writing
f1.comp <- c('<flow title="F1 Component">',
             paste0('<file value="', f1.file, '" />'),
             paste0('<bygone value="', f1.bygone, '" />'),
             paste0('<time0 value="', f1.time0, '" />'),
             paste0('<goal0 value="', f1.goal0, '" />'),
             paste0('<threshLo value="', f1.thlo, '" />'),
             paste0('<threshHi value="', f1.thhi, '" />'),
             paste0('<goalPlus value="', f1.goalplus, '" />'),
             paste0('<goalF value="', f1.goalf, '" />'),
             paste0('<slope value="', f1.slope, '" />'),
             paste0('<weightF value="', f1.weightf, '" />'),
             paste0('<weight0 value="', f1.weight0, '" />'),
             paste0('<model value="', f1.model, '" />'),
             paste0('<title value="', f1.title, '" />'),
             '<bounds height="330" width="366" x="553" y="443" />',
             "</flow>")

```

```{r write.proj.5, warning = FALSE, echo = T, eval = F}

#Provide each of these flow component objects to the function and run
writeProj(f1.comp = f1.comp)


```

Now we have a project file saved to our working directory. Let's open Habplan and see if this has worked. The Habplan program needs to be stored in the working directory that was assigned earlier, so that it can be run from RStudio below.

_IMPORTANT - MUST RENAME SAVEFLOW1 AND SAVESCHED FROM WORKING DIRECTORY IF YOU DO NOT WANT THE FILES TO BE DELETED_

```{r run.habplan.3, warning = FALSE, echo = T, eval = F}

#Open Habplan (if run from here, R functionality will cease until Habplan is closed)
shell("h", wait=TRUE) 


```

After running Habplan, we will have a carbon flow saved to our working directory. The option still exists to interactively watch the charts in a Habplan window. However, we will visualize this flow using the flowPlot function.

```{r flow.read.3, warning = FALSE, echo = T, eval = F}

#Read in the Carbon flow file
flow1 <- read.csv("./saveFlow1", sep="", header = F)

```

```{r flow.read.3.1, warning = FALSE, echo = F, eval = T}

#Read in the Carbon flow file
flow1 <- read.csv("./Carb_3/saveFlow1", sep="", header = F)

```

_IMPORTANT - if the flow1 object has more rows than number of stands something went wrong. Most likely, the saveFlow1 file was not removed from the working directory before Habplan was run._

```{r flow.plot.4, warning = FALSE, echo = T, eval = T}

#Input the flow file into the function, and number of years
flowPlot(flow.data = flow1, nyear = 36)

```

Figure 35. The amount of flow (sequestered carbon) attained over time as a result of the suggested Habplan management schedule.

The above will create a chart for one of the flows. However, it is also useful to be able to visualize the flows in relation to one another. We will therefore use the comPlot function, as we have demonstrated earlier.

This requires the same input as before, but this time we will introduce some of the other flows outputs. Current maximum of 3 flows. 


```{r com.plot.3, warning = FALSE, echo = T, eval = F}

#Let's look at these flows together
flow1 <- read_csv("./saveFlow1_1", col_names = F)
flow2 <- read_csv("./saveFlow1_2", col_names = F)
flow3 <- read_csv("./saveFlow1", col_names = F)
#flow4 <- read.csv("./saveFlow4", sep="")

#Run function with new flows
comPlot(flow.data.1 = flow1, flow.data.2 = flow2, 
        flow.data.3 = flow3, nyear = 36) # 36 years in new Carbon data

```

```{r com.plot.3.2, warning = FALSE, echo = F, eval = T}

#Let's look at these flows together
flow1 <- read_csv("./Carb_1/saveFlow1", col_names = F)
flow2 <- read_csv("./Carb_2/saveFlow1", col_names = F)
flow3 <- read_csv("./Carb_3/saveFlow1", col_names = F)
#flow4 <- read.csv("./saveFlow4", sep="")

#Run function with new flows
comPlot(flow.data.1 = flow1, flow.data.2 = flow2, 
        flow.data.3 = flow3, nyear = 36) # 36 years in new Carbon data

```

Figure 36. The amount of flow (sequestered carbon) attained over time as a result of the three separate Habplan management schedule (flow1, flow2, and flow3). Each flow is represented by a different shade of blue.

## Summary

Above, we have provided very simple examples of how to use HabplanR to run a multi-objective forestry issue in Habplan. The values provided within the vignette are for demonstrative purposes only and do not represent real data. Real-world examples will likely have many more objectives to evaluate, alongside complex spatiotemporal considerations. If you encounter any issues with the HabplanR package, or require help with applying the functions to a novel dataset, feel free to contact Max Jones at maxdoltonjones@vt.edu. To access the member-only version, or for additional help, please contact Holly Munro at hmunro@ncasi.org.

## Acknowledgements

We would like to thank the National Council for Air and Stream Improvement, Inc. for supporting the HabplanR package and vignette. 

## Appendix 1 - FVS variable names and descriptions

* RegimeKey: Unique number used to identify a specific management regime.
* Regime Activity: Descriptions of management regimes used within the Forest Vegetation Simulator growth model to project stand conditions. BA: Basal Area, LL: Loblolly Pine (Pinus taeda), TPA: Trees Per Acre. 
* StandID: Unique forest stand ID.
* Year: Projected year by the growth model for that combination of forest stand and regime.
* Age: Age of forest stand.
* BA: Basal area.
* TPA: Trees per acre.
* Pine_Pulp_Tons: Tons of pine pulpwood.
* Pine_CNS_Tons: Tons of pine chip-n-saw.
* Pine_Saw_Tons: Tons of pine sawtimber.
* Hdwd_Pulp_Tons: Tons of hardwood pulpwood.
* Hdwd_Saw_Tons: Tons of hardwood sawtimber.
* Harv_P_Pulp_Tons: Harvested pine pulpwood (tons/acre).
* Harv_P_CNS_Tons: Harvested pine chip-n-saw (tons/acre).
* Harv_P_Saw_Tons: Harvested pine sawtimber (tons/acre).
* Harv_H_Pulp_Tons: Harvested hardwood pulpwood (tons/acre).
* Harv_H_Saw_Tons: Harvested hardwood sawtimber (tons/acre).
* HSI: Habitat Suitability Index. 

## Appendix 2 - List of HabplanR functions and brief description

* HSIcalc: Calculates HSI and inserts into dataset.
* HabConvert: Converts Forest Vegetation Simulator data (or similar) to Habplan flow file.
* WriteProj: Creates a project file with Habplan configurations/parameters.
* FlowPlot: Plots a single output flow file across time.
* ComPlot: Plots multiple flow files on a combined graph across time.
* StandSched: Adds the top schedule to stand shapefile.
* HabBlock: Creates block size constraint data (adjacency table).
* HabSpace: Spatial analysis of HSI flows.
* lpMPS: Create an MPS file to run the lp solver in Habplan.
* CarbonConvert: Converts growth model projection data with Carbon data to Habplan flow file.


